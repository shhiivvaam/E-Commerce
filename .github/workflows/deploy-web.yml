name: Build & Publish Web Image

# ─────────────────────────────────────────────────────────────────────────────
# What this does:
#   1. Triggers on any push to main that touches the frontend
#   2. Builds the Next.js Docker image  (FAILS HERE → nothing pushed)
#   3. Runs a smoke test against the built image (FAILS HERE → nothing pushed)
#   4. Only if both pass: pushes image to Docker Hub with sha + latest tags
#
# Vercel auto-deploys from GitHub on its own — this workflow exists to:
#   • Guarantee a clean, tested Docker image is always on Docker Hub
#   • Give you a fallback self-hosted image at any time
#   • Prevent broken images from ever reaching the registry
# ─────────────────────────────────────────────────────────────────────────────

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - '.github/workflows/deploy-web.yml'

env:
  IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ecommerce-web

jobs:
  build-test-push:
    name: Build → Smoke Test → Push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Docker setup ──────────────────────────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE }}
          tags: |
            type=sha,prefix=sha-,format=short
            type=raw,value=latest

      # ── Step 1: Build image (do NOT push yet) ────────────────
      # If the build fails for any reason, the job fails here.
      # Nothing is pushed to Docker Hub. Registry stays clean.
      - name: Build image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          dockerfile: ./apps/web/Dockerfile
          push: false
          load: true                        # loads image into local Docker daemon for smoke test
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ── Step 2: Smoke test — start container, hit it, verify 2xx ─
      # If container doesn't respond healthy, job fails here.
      # Nothing is pushed to Docker Hub. Registry stays clean.
      - name: Smoke test built image
        run: |
          echo "▶ Starting web container for smoke test..."
          docker run -d \
            --name web-smoke \
            -p 3000:3000 \
            -e NODE_ENV=production \
            -e NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
            ${{ env.IMAGE }}:latest

          echo "⏳ Waiting for container to be ready (max 60s)..."
          HEALTHY=false
          for i in $(seq 1 12); do
            sleep 5
            HTTP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/ 2>/dev/null || echo "000")
            echo "  Attempt $i/12 — HTTP $HTTP"
            if [[ "$HTTP" =~ ^2 ]]; then
              HEALTHY=true
              echo "✅ Smoke test passed!"
              break
            fi
          done

          docker logs --tail=30 web-smoke || true
          docker stop web-smoke && docker rm web-smoke

          if [ "$HEALTHY" = false ]; then
            echo "❌ Smoke test FAILED — image will NOT be pushed to Docker Hub"
            exit 1
          fi

      # ── Step 3: Push ONLY if build + smoke test both passed ──
      # This is the only step that publishes to Docker Hub.
      - name: Push verified image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          dockerfile: ./apps/web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "## ✅ Web Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| latest | \`${{ env.IMAGE }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| sha    | \`${{ env.IMAGE }}:sha-${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Vercel deployment triggered automatically via GitHub integration." >> $GITHUB_STEP_SUMMARY

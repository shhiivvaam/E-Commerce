name: Build & Deploy API to EC2

on:
  push:
    branches: [main]
    paths:
      # ── Backend source ─────────────────────────────────────────
      - 'apps/api/**'
      # ── Shared packages (affects both apps) ────────────────────
      - 'packages/**'
      # ── Root dependency files (lockfile change = rebuild) ───────
      - 'package.json'
      - 'package-lock.json'
      # ── Infra files this service needs ─────────────────────────
      - 'docker-compose.yml'
      - 'scripts/deploy.sh'
      - 'scripts/ec2-setup.sh'
      # ── This workflow itself ────────────────────────────────────
      - '.github/workflows/deploy-api.yml'
      # ── Explicitly IGNORE frontend-only changes ─────────────────
      - '!apps/web/**'

env:
  IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ecommerce-api

jobs:
  # ─────────────────────────────────────────────────────────────
  # Job 1: Build & push to Docker Hub
  # Only runs if paths above changed. If this fails, Job 2 never runs.
  # ─────────────────────────────────────────────────────────────
  build-and-push:
    name: Build & Push to Docker Hub
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata (tags & labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE }}
          tags: |
            type=sha,prefix=sha-,format=short
            type=raw,value=latest

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          dockerfile: ./apps/api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ─────────────────────────────────────────────────────────────
  # Job 2: Deploy to EC2
  # Only runs after Job 1 succeeds — image is guaranteed to exist.
  # Uses deploy.sh for zero-downtime blue-green + auto-rollback.
  # ─────────────────────────────────────────────────────────────
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Upload the deploy script to EC2 ──────────────────────
      - name: Upload deploy.sh to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: scripts/deploy.sh
          target: ~/ecommerce/
          strip_components: 1           # drops the "scripts/" prefix

      # ── Run zero-downtime deploy with auto-rollback ───────────
      - name: Run deploy.sh on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 3m
          script: |
            chmod +x ~/ecommerce/deploy.sh
            bash ~/ecommerce/deploy.sh "${{ env.IMAGE }}" "latest"

      - name: Summary
        run: |
          echo "## ✅ API Deployed to EC2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.IMAGE }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Host  | \`${{ secrets.EC2_HOST }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Time  | $(date -u) |" >> $GITHUB_STEP_SUMMARY
